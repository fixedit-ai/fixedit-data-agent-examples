# This override file:
# - Adds healthchecks to InfluxDB and Grafana
# - Overrides production secrets for InfluxDB and Grafana
# - Supports multiple deployments on same host using COMPOSE_PROJECT_NAME
#
# This stack is only intended as an example.

version: "3.8"

services:
  influxdb:
    container_name: influxdb-${COMPOSE_PROJECT_NAME:-default}
    environment:
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    labels:
      - "com.ouroboros.enable=true" # Explicitly allow monitoring
    restart: unless-stopped

  grafana:
    container_name: grafana-${COMPOSE_PROJECT_NAME:-default}
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - INFLUXDB_TOKEN=${INFLUXDB_ADMIN_TOKEN}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    labels:
      - "com.ouroboros.enable=true" # Explicitly allow monitoring
    restart: unless-stopped
