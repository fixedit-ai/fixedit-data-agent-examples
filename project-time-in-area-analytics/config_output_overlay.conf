# Axis Overlay Output Configuration
#
# This configuration uses Telegraf's exec output plugin to trigger the
# overlay_manager.sh script whenever objects exceed the time-in-area threshold.
#
# Key Features:
# - Executes shell script for each overlay event
# - Immediate execution with no batching for real-time response
# - JSON data format for structured communication with script
# - Timeout protection for API call sequences
# - Exec plugin runs external commands with metric data as stdin
# - Script receives JSON with overlay information including coordinates, class, and time
#
# Environment Variables Required:
# - HELPER_FILES_DIR: Directory containing overlay_manager.sh script (set automatically by the FixedIt Data Agent)
# - VAPIX_USERNAME: Axis device username
# - VAPIX_PASSWORD: Axis device password
# - VAPIX_IP: IP address of the Axis device, should be 127.0.0.1 when running in the FixedIT Data Agent on an Axis device.

[[outputs.exec]]
  # Filter to process only overlay metrics from the Starlark processor
  # This ensures the script only runs when overlay data is ready
  namepass = ["overlay_frame"]

  # Shell script command to execute for each overlay event
  # The script receives JSON data via stdin and controls the overlay display
  # HELPER_FILES_DIR should point to the directory containing the script,
  # which is set automatically by the FixedIt Data Agent to the directory where
  # helper files are uploaded.
  command = ["${HELPER_FILES_DIR}/overlay_manager.sh"]

  # Data format sent to the script via stdin
  # JSON format provides structured data that the script can parse easily
  # Format: {"fields":{"track_id":"123","time_in_area_seconds":45.2,"class":"Human",...},"name":"detection_frame",...}
  data_format = "json"

  # Disable batch format to send individual metrics to the script.
  # When false: sends single metric JSON object per execution.
  # When true: would send array of metrics (not needed for this use case).
  use_batch_format = false

  # Immediate execution settings for real-time response.
  # These settings minimize delay between threshold detection and overlay display.

  # Process one metric at a time for immediate response.
  # This ensures each overlay event triggers script execution immediately.
  # Higher values would batch multiple changes (undesirable for visual feedback).
  metric_batch_size = 1

  # Minimal buffer size. 2*metric_batch_size is the minimum value allowed in the
  # configuration according to the documentation.
  metric_buffer_limit = 2

  # Script execution timeout to prevent hanging.
  # The script makes VAPIX API calls to manage overlays.
  # 15 seconds allows sufficient time for network round trips and error handling.
  # Increase if experiencing timeout issues on slow networks.
  # Setting this makes the application more robust since it can recover from
  # a hanging script.
  timeout = "15s"

  # Flush interval set to 1 second to ensure timely processing.
  flush_interval = "1s"
