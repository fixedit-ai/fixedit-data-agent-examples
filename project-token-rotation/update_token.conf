# This input configuration periodically requests a new token from the server
# It uses the token from token.txt if available, otherwise falls back to bootstrap token

[[inputs.exec]]
  # Request a new token every 5 seconds
  interval = "5s"
  commands = ["${HELPER_FILES_DIR}/send_http_request.sh --url http://${SERVER_URL}:8000/generate-token --request-metrics --default-token ${BOOTSTRAP_TOKEN}"]
  data_format = "json"
  json_string_fields = [
    "serial",
    "token",
  ]
  name_override = "device_token"

# Exec output to save the token to a file (keeping only last 2 tokens)
[[outputs.exec]]
  # Only consume the device_token metric (new token)
  namepass = ["device_token"]

  # Keep last token + add new token, then atomically replace file
  command = ["sh", "-c", "{ tail -n 1 ${HELPER_FILES_DIR}/token.txt 2>/dev/null; cat; } > ${HELPER_FILES_DIR}/token.txt.tmp && mv ${HELPER_FILES_DIR}/token.txt.tmp ${HELPER_FILES_DIR}/token.txt"]
  data_format = "json"

  # Make sure to flush directly to the file so that other
  # scripts can make use of the token as soon as possible.
  flush_interval = "1s"
  metric_batch_size = 1

  # Disable batch format to send individual metrics to the script.
  # When false: sends single metric JSON object per execution.
  use_batch_format = false

# For debugging; also print to stdout
[[outputs.file]]
  # Only consume the device_token metric (new token)
  namepass = ["device_token"]

  files = ["stdout"]
  data_format = "json"
